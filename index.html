<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UQ BEP Reading Simulator</title>
    <style>
        :root { 
            --primary: #51247a; 
            --secondary: #962a8b; 
            --bg: #f5f7fa; 
            --text: #2c3e50; 
            --success: #27ae60; 
            --error: #c0392b; 
            --warning: #f39c12;
            --selected-bg: #eaddff; 
            --selected-border: #51247a; 
        }
        
        body { font-family: 'Segoe UI', Inter, sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; min-height: 100vh; margin: 0; padding: 20px; color: var(--text); }
        
        /* ÈÄöÁî®ÂÆπÂô® */
        .container { max-width: 900px; width: 100%; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); display: none; margin-bottom: 40px;}
        
        /* È¶ñÈ°µÊ®°ÂºèÈÄâÊã©Âç°Áâá */
        .mode-selection { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
        .mode-card { border: 2px solid #eee; padding: 25px; border-radius: 12px; cursor: pointer; transition: all 0.2s; text-align: left; }
        .mode-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .mode-card.selected { border-color: var(--primary); background-color: var(--selected-bg); }
        .mode-card h3 { margin-top: 0; color: var(--primary); }
        
        /* È°∂ÈÉ®Áä∂ÊÄÅÊ†è */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px; position: sticky; top: 0; background: white; z-index: 100; padding-top: 10px;}
        .timer { font-size: 1.8rem; font-weight: 800; color: var(--error); font-variant-numeric: tabular-nums; }
        
        /* ÈòÖËØªÊùêÊñôÊ†∑Âºè */
        .passage { 
            font-size: 1.1rem; 
            line-height: 1.7; 
            color: #2c3e50; 
            background: #fffbf2; 
            padding: 25px; 
            border-radius: 8px; 
            border: 1px solid #e0e0e0; 
            margin-bottom: 25px; 
            text-align: justify; 
        }
        
        .stage-badge { display: inline-block; padding: 5px 12px; border-radius: 4px; font-weight: bold; color: white; margin-bottom: 10px; font-size: 0.9rem; background: var(--secondary); }

        /* Stage 1 ÈÄâÈ°πÂç°Áâá */
        .option-card { padding: 15px; border: 2px solid #e2e8f0; border-radius: 8px; cursor: pointer; margin-bottom: 10px; transition: all 0.2s; display: flex; }
        .option-card:hover { background: #fafafa; border-color: #bbb; }
        .option-card.selected { background-color: var(--selected-bg); border-color: var(--selected-border); }

        /* Stage 2 Ê†∑Âºè */
        .headings-box { background: #e8f4f8; padding: 20px; border-radius: 8px; border-left: 5px solid #2980b9; margin-bottom: 30px; }
        .headings-list li { margin-bottom: 8px; font-weight: 500; }
        .match-select { width: 100%; padding: 12px; font-size: 1rem; border: 2px solid #ddd; border-radius: 6px; background: white; margin-top: 10px; }
        .match-select:focus { border-color: var(--primary); outline: none; }

        /* ÊåâÈíÆ */
        .action-btn { padding: 12px 30px; font-size: 1rem; border-radius: 8px; cursor: pointer; border: none; font-weight: 600; width: 100%; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--secondary); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }

        /* Loading & Results */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Â§çÁõòÁªìÊûúÊ†∑Âºè */
        .review-card { border: 1px solid #eee; padding: 20px; margin-bottom: 20px; border-radius: 8px; background: white; }
        .correct-tag { color: var(--success); font-weight: bold; }
        .wrong-tag { color: var(--error); font-weight: bold; text-decoration: line-through; }
        
        /* ÁßªÂä®Á´ØÈÄÇÈÖç */
        @media (max-width: 600px) {
            .mode-selection { grid-template-columns: 1fr; }
            .container { padding: 20px; }
        }
    </style>
</head>
<body>

    <div id="setup" class="container" style="display: block; text-align: center; margin-top: 50px;">
        <h1 style="color: var(--primary); margin-bottom: 10px;">UQ BEP Reading Simulator</h1>
        <p style="color: #666;">Select your exam stage to begin</p>
        
        <div class="mode-selection">
            <div class="mode-card" id="card-stage1" onclick="selectMode('stage1')">
                <h3>Stage 1: MCQs</h3>
                <p><strong>Format:</strong> 8 Paragraphs</p>
                <p><strong>Task:</strong> Multiple Choice (4 options)</p>
                <p><strong>Time:</strong> ~16 mins</p>
            </div>
            
            <div class="mode-card" id="card-stage2" onclick="selectMode('stage2')">
                <h3>Stage 2: Matching</h3>
                <p><strong>Format:</strong> 7 Sections (A-G)</p>
                <p><strong>Task:</strong> Match Headings (9 options)</p>
                <p><strong>Time:</strong> 2 + 8 mins</p>
            </div>
        </div>

        <div style="margin-top: 30px;">
            <input type="text" id="access-token" placeholder="Enter Access Code (Optional)" style="padding: 10px; width: 60%; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;">
            <button class="action-btn btn-primary" onclick="initExam()" id="start-btn" disabled>Select a Mode First</button>
        </div>

        <div id="loading" style="display: none;">
            <div class="loader"></div> 
            <p>Connecting to UQ Examiner AI...<br><small>(First load may take 60s, please wait)</small></p>
        </div>
    </div>

    <div id="exam-stage1" class="container">
        <div class="header">
            <div><strong>Stage 1</strong>: Q <span id="s1-q-num">1</span> / 8</div>
            <div id="timer-s1" class="timer">01:00</div>
        </div>
        <span id="s1-phase-badge" class="stage-badge">PHASE 1: READING</span>
        <div id="s1-passage" class="passage"></div>
        <h3 id="s1-question" style="display: none; color: var(--primary);">Loading Question...</h3>
        <div id="s1-options" style="display: none;"></div>
        <button id="s1-next-btn" class="action-btn btn-primary" onclick="submitStage1Question()" style="display: none; margin-top: 20px;">Next Question</button>
    </div>

    <div id="exam-stage2" class="container">
        <div class="header">
            <div><strong>Stage 2</strong>: Matching Headings</div>
            <div id="timer-s2" class="timer">02:00</div>
        </div>

        <div id="s2-phase1" style="display: block;">
            <div class="headings-box">
                <h3 style="margin-top:0;">List of Headings (Preview)</h3>
                <ul id="s2-headings-preview" class="headings-list"></ul>
            </div>
            <p style="text-align: center; color: #666;">Memorize these headings. You have 2 minutes.</p>
        </div>

        <div id="s2-phase2" style="display: none;">
            <div class="headings-box" style="padding: 10px 20px;">
                <h4 style="margin:0; cursor: pointer;" onclick="document.getElementById('s2-headings-ref').style.display = document.getElementById('s2-headings-ref').style.display === 'none' ? 'block' : 'none'">
                    üëÅÔ∏è Toggle List of Headings Reference
                </h4>
                <ul id="s2-headings-ref" class="headings-list" style="display: none; margin-top: 10px;"></ul>
            </div>

            <h2 id="s2-title" style="text-align: center; color: var(--primary);"></h2>
            <div id="s2-passages-container"></div>
            
            <button class="action-btn btn-primary" onclick="finishStage2()" style="margin-top: 30px;">Submit All Matches</button>
        </div>
    </div>

    <div id="scoreboard" class="container">
        <div style="text-align: center; border-bottom: 2px solid #eee; padding-bottom: 20px;">
            <h1 style="color: var(--primary);">Exam Results</h1>
            <h2 style="font-size: 3rem; margin: 10px 0;">
                <span id="final-score" style="color: var(--success);">0</span> 
                <span style="font-size: 1.5rem; color: #999;">/ Total</span>
            </h2>
            <button class="action-btn btn-primary" onclick="location.reload()">Start New Exam</button>
        </div>
        <div id="review-content" style="margin-top: 30px;"></div>
    </div>

    <script>
        // --- ÈÖçÁΩÆ ---
        // ‚ö†Ô∏è ËØ∑Âä°ÂøÖÁ°Æ‰øùËøôÈáåÁöÑÂú∞ÂùÄÊòØ‰Ω† Render ÁöÑÁúüÂÆûÂú∞ÂùÄÔºå‰∏çË¶ÅÂ∏¶Â§ö‰ΩôÁ©∫Ê†º
        const API_URL = "http://127.0.0.1:5000/generate-exam"; 
        
        // --- ÂÖ®Â±ÄÂèòÈáè ---
        let currentMode = null;
        let examData = null;
        let timerInterval = null;
        
        // Stage 1 ÂèòÈáè
        let s1Index = 0;
        let s1UserAnswers = [];
        let s1CurrentSelection = null;

        // Stage 2 ÂèòÈáè
        let s2UserAnswers = {}; // {A: "i", B: "iv"...}

        // --- 1. Ê®°ÂºèÈÄâÊã© ---
        function selectMode(mode) {
            currentMode = mode;
            // UI Êõ¥Êñ∞
            document.querySelectorAll('.mode-card').forEach(el => el.classList.remove('selected'));
            document.getElementById('card-' + mode).classList.add('selected');
            
            const btn = document.getElementById('start-btn');
            btn.disabled = false;
            btn.innerText = `Start ${mode === 'stage1' ? 'Stage 1' : 'Stage 2'} Exam`;
        }

        // --- 2. ÂàùÂßãÂåñËÄÉËØï (Ëé∑ÂèñÊï∞ÊçÆ) ---
        async function initExam() {
            if (!currentMode) return;

            // UI ÂàáÊç¢
            document.getElementById('setup').style.display = 'none'; // ÊöÇÊó∂ÈöêËóè setupÔºå‰πüÂèØ‰ª•‰øùÁïô
            document.getElementById('start-btn').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
            document.getElementById('setup').style.display = 'block'; // ‰øùÊåÅ loading Âú®‰∏≠Èó¥

            const token = document.getElementById('access-token').value.trim() || "guest";

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        token: token,
                        stage: currentMode // ÂÖ≥ÈîÆÔºö‰º†ÁªôÂêéÁ´Ø stage ÂèÇÊï∞
                    })
                });

                if (!response.ok) throw new Error("Server Error: " + response.status);
                
                const data = await response.json();
                
                document.getElementById('setup').style.display = 'none';
                
                if (currentMode === 'stage1') {
                    if(!data.exam_set) throw new Error("Invalid Stage 1 Data");
                    examData = data.exam_set;
                    startStage1();
                } else {
                    if(!data.sections) throw new Error("Invalid Stage 2 Data");
                    examData = data;
                    startStage2();
                }

            } catch (err) {
                console.error(err);
                alert("Failed to load exam. Please check your connection or try again later.\nError: " + err.message);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('start-btn').style.display = 'block';
            }
        }

        // ================= STAGE 1 ÈÄªËæë (ÈÄâÊã©È¢ò) =================
        function startStage1() {
            document.getElementById('exam-stage1').style.display = 'block';
            s1Index = 0;
            s1UserAnswers = [];
            loadStage1Question();
        }

        function loadStage1Question() {
            const q = examData[s1Index];
            s1CurrentSelection = null;
            
            // ÈáçÁΩÆ UI
            document.getElementById('s1-q-num').innerText = s1Index + 1;
            document.getElementById('s1-passage').innerText = q.passage;
            document.getElementById('s1-phase-badge').innerText = "PHASE 1: READING (60s)";
            document.getElementById('s1-phase-badge').style.background = "#e67e22";
            document.getElementById('s1-question').style.display = 'none';
            document.getElementById('s1-options').style.display = 'none';
            document.getElementById('s1-next-btn').style.display = 'none';

            // Phase 1 ÂÄíËÆ°Êó∂
            startTimer(60, document.getElementById('timer-s1'), () => {
                // ËøõÂÖ• Phase 2
                document.getElementById('s1-phase-badge').innerText = "PHASE 2: ANSWERING (60s)";
                document.getElementById('s1-phase-badge').style.background = "#27ae60";
                
                document.getElementById('s1-question').innerText = q.question;
                document.getElementById('s1-question').style.display = 'block';
                
                // Ê∏≤ÊüìÈÄâÈ°π
                const optContainer = document.getElementById('s1-options');
                optContainer.innerHTML = q.options.map((opt, i) => `
                    <div class="option-card" id="opt-${i}" onclick="selectS1Option(${i})">
                        <strong style="margin-right:10px;">${String.fromCharCode(65+i)}.</strong> ${opt}
                    </div>
                `).join('');
                optContainer.style.display = 'block';
                document.getElementById('s1-next-btn').style.display = 'block';
                document.getElementById('s1-next-btn').disabled = true;

                // Phase 2 ÂÄíËÆ°Êó∂
                startTimer(60, document.getElementById('timer-s1'), () => {
                    submitStage1Question(); // Ë∂ÖÊó∂Ëá™Âä®Êèê‰∫§
                });
            });
        }

        function selectS1Option(idx) {
            s1CurrentSelection = idx;
            document.querySelectorAll('.option-card').forEach(el => el.classList.remove('selected'));
            document.getElementById('opt-'+idx).classList.add('selected');
            document.getElementById('s1-next-btn').disabled = false;
        }

        function submitStage1Question() {
            clearInterval(timerInterval);
            s1UserAnswers.push(s1CurrentSelection === null ? -1 : s1CurrentSelection);
            
            if (s1Index < 7) {
                s1Index++;
                loadStage1Question();
            } else {
                showResultsStage1();
            }
        }

        // ================= STAGE 2 ÈÄªËæë (ÂåπÈÖçÈ¢ò) =================
        function startStage2() {
            document.getElementById('exam-stage2').style.display = 'block';
            
            // Ê∏≤Êüì Headings ÂàóË°® (i - ix)
            const headingsHtml = Object.keys(examData.headings).map(key => 
                `<li><span style="color:var(--primary); width:30px; display:inline-block;">${key}.</span> ${examData.headings[key]}</li>`
            ).join('');
            
            document.getElementById('s2-headings-preview').innerHTML = headingsHtml;
            document.getElementById('s2-headings-ref').innerHTML = headingsHtml;

            // Phase 1: 2ÂàÜÈíüÈ¢ÑËØª Headings
            startTimer(120, document.getElementById('timer-s2'), () => {
                enterStage2Phase2();
            });
        }

        function enterStage2Phase2() {
            document.getElementById('s2-phase1').style.display = 'none';
            document.getElementById('s2-phase2').style.display = 'block';
            document.getElementById('s2-title').innerText = examData.title;

            // ÁîüÊàê‰∏ãÊãâÈÄâÈ°π HTML
            let optionsHtml = '<option value="" disabled selected>Select Heading...</option>';
            for (let key in examData.headings) {
                optionsHtml += `<option value="${key}">${key}. ${examData.headings[key]}</option>`;
            }

            // Ê∏≤ÊüìÊâÄÊúâÊñáÁ´†ÊÆµËêΩ (A-G)
            const container = document.getElementById('s2-passages-container');
            container.innerHTML = examData.sections.map(sec => `
                <div class="passage" style="position: relative;">
                    <div style="position:absolute; top:-10px; left:-10px; background:var(--primary); color:white; padding:5px 10px; font-weight:bold; border-radius:4px;">
                        Section ${sec.id}
                    </div>
                    <p style="margin-top:15px;">${sec.text}</p>
                    
                    <div style="background:#eee; padding:10px; border-radius:6px; display:flex; align-items:center;">
                        <strong style="margin-right:10px;">Answer:</strong>
                        <select class="match-select" onchange="s2UserAnswers['${sec.id}'] = this.value">
                            ${optionsHtml}
                        </select>
                    </div>
                </div>
            `).join('');

            // Phase 2: 8ÂàÜÈíüÂÅöÈ¢ò
            setTimeout(() => {
                alert("Reading Phase Started! You have 8 minutes to match sections.");
                startTimer(480, document.getElementById('timer-s2'), finishStage2);
            }, 100);
        }

        function finishStage2() {
            clearInterval(timerInterval);
            showResultsStage2();
        }

        // ================= ÈÄöÁî®ÂäüËÉΩ =================
        function startTimer(seconds, displayElem, onComplete) {
            clearInterval(timerInterval);
            let timeLeft = seconds;
            
            function update() {
                let m = Math.floor(timeLeft / 60);
                let s = timeLeft % 60;
                displayElem.innerText = `${m}:${s < 10 ? '0'+s : s}`;
                if (timeLeft <= 10) displayElem.style.color = 'red';
                else displayElem.style.color = 'var(--error)';
            }
            update();

            timerInterval = setInterval(() => {
                timeLeft--;
                update();
                if (timeLeft < 0) {
                    clearInterval(timerInterval);
                    onComplete();
                }
            }, 1000);
        }

        // ================= ÁªìÊûúÁªìÁÆó =================
        function showResultsStage1() {
            document.getElementById('exam-stage1').style.display = 'none';
            document.getElementById('scoreboard').style.display = 'block';
            
            let score = 0;
            let html = '';

            examData.forEach((q, i) => {
                const correct = q.correct;
                const user = s1UserAnswers[i];
                if (user === correct) score++;
                
                const userText = user === -1 ? "Skipped" : String.fromCharCode(65+user);
                const correctText = String.fromCharCode(65+correct);
                const isCorrect = user === correct;

                html += `
                    <div class="review-card" style="border-left: 5px solid ${isCorrect ? 'var(--success)' : 'var(--error)'}">
                        <h4>Question ${i+1}</h4>
                        <p style="font-size:0.9rem; color:#666;">${q.question}</p>
                        <p>Your Answer: <span class="${isCorrect ? 'correct-tag' : 'wrong-tag'}">${userText}</span></p>
                        ${!isCorrect ? `<p>Correct Answer: <span class="correct-tag">${correctText}</span></p>` : ''}
                    </div>
                `;
            });
            
            document.getElementById('final-score').innerText = `${score} / 8`;
            document.getElementById('review-content').innerHTML = html;
        }

        function showResultsStage2() {
            document.getElementById('exam-stage2').style.display = 'none';
            document.getElementById('scoreboard').style.display = 'block';

            let score = 0;
            let html = '';

            examData.sections.forEach(sec => {
                const correct = sec.correct_heading;
                const user = s2UserAnswers[sec.id] || "No Answer";
                const isCorrect = user === correct;
                
                if (isCorrect) score++;

                html += `
                    <div class="review-card" style="border-left: 5px solid ${isCorrect ? 'var(--success)' : 'var(--error)'}">
                        <h4>Section ${sec.id}</h4>
                        <p style="font-size:0.9rem;">${sec.text.substring(0, 80)}...</p>
                        <p>Your Match: <span class="${isCorrect ? 'correct-tag' : 'wrong-tag'}">${user}</span> 
                           ${!isCorrect ? `(Correct: <span class="correct-tag">${correct}</span>)` : ''}
                        </p>
                        <p style="font-size:0.8rem; color:#666;">Heading Text: ${examData.headings[correct]}</p>
                    </div>
                `;
            });

            document.getElementById('final-score').innerText = `${score} / 7`;
            document.getElementById('review-content').innerHTML = html;
        }

    </script>
</body>
</html>